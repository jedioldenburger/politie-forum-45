"use client";

import AuthModal from "@/components/AuthModal";
import Header from "@/components/Header";
import { useAuth } from "@/contexts/AuthContext";
import { formatDistanceToNow } from "date-fns";
import { nl } from "date-fns/locale";
import {
  ArrowLeft,
  Award,
  CheckCircle,
  Code,
  Copy,
  Crown,
  Database,
  Download,
  Flame,
  Image as ImageIcon,
  MessageSquare,
  Pin,
  RefreshCw,
  Star,
  Target,
  ThumbsUp,
  Trash2,
  Trophy,
  X
} from "lucide-react";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";

interface Comment {
  id: string;
  authorId: string;
  authorName: string;
  authorPhotoURL?: string;
  content: string;
  createdAt: number;
  likes: number;
  likedBy?: { [uid: string]: boolean };
  parentCommentId?: string;
  replies?: Comment[]; // Nested replies
  isPinned?: boolean;
  isBestAnswer?: boolean;
  editedAt?: number;
  imageUrl?: string; // Uploaded image
  imageSize?: number; // Image size in bytes
  links?: string[]; // Extracted URLs from content
}

interface UserStats {
  userId: string;
  userName: string;
  photoURL?: string;
  commentsCount: number;
  likesReceived: number;
  bestAnswers: number;
  badges: string[];
  level: number;
  score: number;
}

interface Badge {
  id: string;
  name: string;
  description: string;
  icon: string;
  color: string;
  requirement: number;
  type: 'comments' | 'likes' | 'bestAnswers' | 'replies' | 'streak';
}

const PLAYGROUND_ARTICLE_SLUG = "playground-threaded-demo";

const BADGES: Badge[] = [
  { id: 'first-post', name: 'Eerste Post', description: 'Plaats je eerste reactie', icon: 'üéØ', color: 'bg-blue-500', requirement: 1, type: 'comments' },
  { id: 'conversationalist', name: 'Prater', description: 'Plaats 10 reacties', icon: 'üí¨', color: 'bg-green-500', requirement: 10, type: 'comments' },
  { id: 'popular', name: 'Populair', description: 'Ontvang 25 likes', icon: '‚≠ê', color: 'bg-yellow-500', requirement: 25, type: 'likes' },
  { id: 'expert', name: 'Expert', description: 'Krijg 3 beste antwoorden', icon: 'üèÜ', color: 'bg-purple-500', requirement: 3, type: 'bestAnswers' },
  { id: 'veteran', name: 'Veteraan', description: 'Plaats 50 reacties', icon: 'üéñÔ∏è', color: 'bg-red-500', requirement: 50, type: 'comments' },
  { id: 'legend', name: 'Legende', description: 'Ontvang 100 likes', icon: 'üëë', color: 'bg-orange-500', requirement: 100, type: 'likes' },
  { id: 'helper', name: 'Helper', description: 'Plaats 20 antwoorden', icon: 'ü§ù', color: 'bg-teal-500', requirement: 20, type: 'replies' },
  { id: 'on-fire', name: 'On Fire', description: '7 dagen streak', icon: 'üî•', color: 'bg-pink-500', requirement: 7, type: 'streak' },
];

const getUserLevel = (score: number): number => {
  if (score < 100) return 1;
  if (score < 250) return 2;
  if (score < 500) return 3;
  if (score < 1000) return 4;
  if (score < 2500) return 5;
  return 6;
};

const getLevelName = (level: number): string => {
  const levels = ['Rookie', 'Member', 'Regular', 'Expert', 'Master', 'Legend'];
  return levels[level - 1] || 'Rookie';
};

const calculateScore = (stats: Partial<UserStats>): number => {
  return (stats.commentsCount || 0) * 10 +
         (stats.likesReceived || 0) * 5 +
         (stats.bestAnswers || 0) * 50;
};

export default function ThreadsPlayground() {
  const { currentUser } = useAuth();
  const [comments, setComments] = useState<Comment[]>([]);
  const [newComment, setNewComment] = useState("");
  const [replyingTo, setReplyingTo] = useState<string | null>(null);
  const [replyText, setReplyText] = useState("");
  const [loading, setLoading] = useState(true);
  const [useLiveData, setUseLiveData] = useState(true);
  const [authModalOpen, setAuthModalOpen] = useState(false);
  const [userStats, setUserStats] = useState<UserStats[]>([]);
  const [showLeaderboard, setShowLeaderboard] = useState(false);
  const [showBadges, setShowBadges] = useState(false);
  const [editingCommentId, setEditingCommentId] = useState<string | null>(null);
  const [editText, setEditText] = useState("");

  // Image upload states
  const [uploadingImage, setUploadingImage] = useState(false);
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [imageSize, setImageSize] = useState<number>(0);
  const [replyImage, setReplyImage] = useState<string | null>(null);
  const [replyImageSize, setReplyImageSize] = useState<number>(0);

  // Load comments from Firebase or use sample data
  useEffect(() => {
    if (useLiveData) {
      loadCommentsFromFirebase();
    } else {
      loadSampleData();
    }
  }, [useLiveData]);

  async function loadCommentsFromFirebase() {
    try {
      setLoading(true);
      const { ref, get, query, orderByChild } = await import("firebase/database");
      const { database } = await import("@/lib/firebase");

      if (!database) {
        console.warn("Firebase not initialized, using sample data");
        loadSampleData();
        return;
      }

      const commentsRef = ref(database, "comments");
      const commentsQuery = query(commentsRef, orderByChild("articleSlug"));
      const snapshot = await get(commentsQuery);

      if (snapshot.exists()) {
        const data = snapshot.val();
        const allComments = Object.keys(data)
          .filter((key) => data[key].articleSlug === PLAYGROUND_ARTICLE_SLUG)
          .map((key) => ({ id: key, ...data[key] }))
          .sort((a: any, b: any) => b.createdAt - a.createdAt); // Newest first

        // Build nested structure
        const nested = buildNestedComments(allComments);
        setComments(nested);
        calculateUserStats(nested); // Calculate user stats
      } else {
        setComments([]);
        setUserStats([]); // Clear stats if no comments
      }
    } catch (error) {
      console.error("Error loading comments:", error);
      loadSampleData();
    } finally {
      setLoading(false);
    }
  }

  function loadSampleData() {
    const sampleComments: Comment[] = [
      {
        id: "sample1",
        authorId: "user1",
        authorName: "Jedi Xcom",
        authorPhotoURL:
          "https://lh3.googleusercontent.com/a/ACg8ocLjCLqEzVw2hCUqsLgZR5f3F0miP1MB3LXYPKucExn7LAbngpfA=s96-c",
        content: "Dit is een top-level comment met nested replies (SAMPLE DATA)",
        createdAt: Date.now() - 1000 * 60 * 15,
        likes: 3,
        replies: [
          {
            id: "sample2",
            authorId: "user2",
            authorName: "Agent Smith",
            content: "Eerste nested reply - diepte niveau 1",
            createdAt: Date.now() - 1000 * 60 * 10,
            likes: 1,
            parentCommentId: "sample1",
            replies: [
              {
                id: "sample3",
                authorId: "user1",
                authorName: "Jedi Xcom",
                content: "Nested reply op niveau 2 - kan oneindig diep!",
                createdAt: Date.now() - 1000 * 60 * 5,
                likes: 2,
                parentCommentId: "sample2",
              },
            ],
          },
          {
            id: "sample4",
            authorId: "user3",
            authorName: "Moderator",
            content: "Nog een reply op niveau 1",
            createdAt: Date.now() - 1000 * 60 * 3,
            likes: 0,
            parentCommentId: "sample1",
          },
        ],
      },
      {
        id: "sample5",
        authorId: "user2",
        authorName: "Agent Smith",
        content: "Tweede top-level comment zonder replies (SAMPLE DATA)",
        createdAt: Date.now() - 1000 * 60 * 20,
        likes: 1,
      },
    ];

    setComments(sampleComments);
    setLoading(false);
  }

  function buildNestedComments(flatComments: any[]): Comment[] {
    const commentMap = new Map<string, Comment>();
    const rootComments: Comment[] = [];

    // First pass: create all comment objects
    flatComments.forEach((comment) => {
      commentMap.set(comment.id, { ...comment, replies: [] });
    });

    // Second pass: build the tree
    flatComments.forEach((comment) => {
      const commentObj = commentMap.get(comment.id)!;
      if (comment.parentCommentId) {
        const parent = commentMap.get(comment.parentCommentId);
        if (parent) {
          parent.replies = parent.replies || [];
          parent.replies.push(commentObj);
        } else {
          rootComments.push(commentObj);
        }
      } else {
        rootComments.push(commentObj);
      }
    });

    return rootComments;
  }

  // Calculate user stats from comments
  const calculateUserStats = useCallback((commentsData: Comment[]) => {
    const statsMap = new Map<string, UserStats>();

    const processComment = (comment: Comment) => {
      if (!statsMap.has(comment.authorId)) {
        statsMap.set(comment.authorId, {
          userId: comment.authorId,
          displayName: comment.authorName,
          commentsCount: 0,
          likesReceived: 0,
          bestAnswers: 0,
          badges: [],
          level: 1,
          score: 0
        });
      }

      const stats = statsMap.get(comment.authorId)!;
      stats.commentsCount++;
      stats.likesReceived += comment.likes || 0;
      if (comment.isBestAnswer) stats.bestAnswers++;

      // Process replies recursively
      if (comment.replies && comment.replies.length > 0) {
        comment.replies.forEach(reply => processComment(reply));
      }
    };

    commentsData.forEach(comment => processComment(comment));

    // Calculate scores and assign badges
    const statsArray = Array.from(statsMap.values()).map(stats => {
      const score = calculateScore(stats.commentsCount, stats.likesReceived, stats.bestAnswers);
      const level = getUserLevel(score);
      const earnedBadges: string[] = [];

      // Award badges
      if (stats.commentsCount >= 1) earnedBadges.push('first-post');
      if (stats.commentsCount >= 10) earnedBadges.push('conversationalist');
      if (stats.likesReceived >= 50) earnedBadges.push('popular');
      if (stats.bestAnswers >= 5) earnedBadges.push('expert');
      if (stats.commentsCount >= 100) earnedBadges.push('veteran');
      if (score >= 1000) earnedBadges.push('legend');
      if (stats.bestAnswers >= 10) earnedBadges.push('helper');

      return { ...stats, score, level, badges: earnedBadges };
    });

    // Sort by score descending
    statsArray.sort((a, b) => b.score - a.score);
    setUserStats(statsArray);
  }, []);

  async function handleSubmitComment(e: React.FormEvent) {
    e.preventDefault();
    if (!newComment.trim() || !currentUser) return;

    try {
      const { ref, push, set } = await import("firebase/database");
      const { database } = await import("@/lib/firebase");

      if (!database) {
        alert("Firebase not initialized");
        return;
      }

      // Extract URLs from comment
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const links = newComment.match(urlRegex) || [];

      const commentsRef = ref(database, "comments");
      const newCommentRef = push(commentsRef);

      const commentData: any = {
        articleSlug: PLAYGROUND_ARTICLE_SLUG,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email || "Anonymous",
        content: newComment,
        createdAt: Date.now(),
        likes: 0,
      };

      // Fetch user's custom photoURL from Firebase database
      try {
        const { ref, get } = await import("firebase/database");
        const { database } = await import("@/lib/firebase");
        if (database) {
          const userRef = ref(database, `users/${currentUser.uid}`);
          const userSnapshot = await get(userRef);
          if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            if (userData.photoURL && userData.photoURL.trim()) {
              commentData.authorPhotoURL = userData.photoURL;
            }
          }
        }
      } catch (error) {
        console.log("Could not fetch user photo, using default");
      }

      // Fallback to currentUser.photoURL if no custom photo
      if (!commentData.authorPhotoURL && currentUser.photoURL && currentUser.photoURL.trim()) {
        commentData.authorPhotoURL = currentUser.photoURL;
      }

      // Only add optional fields if they have values
      if (selectedImage) {
        commentData.imageUrl = selectedImage;
        commentData.imageSize = imageSize;
      }
      if (links.length > 0) {
        commentData.links = links;
      }

      await set(newCommentRef, commentData);

      setNewComment("");
      setSelectedImage(null);
      setImageSize(0);
      await loadCommentsFromFirebase();
    } catch (error) {
      console.error("Error submitting comment:", error);
      alert("Fout bij plaatsen reactie");
    }
  }

  async function handleSubmitReply(commentId: string) {
    if (!replyText.trim() || !currentUser) return;

    try {
      const { ref, push, set } = await import("firebase/database");
      const { database } = await import("@/lib/firebase");

      if (!database) {
        alert("Firebase not initialized");
        return;
      }

      // Extract URLs from reply
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const links = replyText.match(urlRegex) || [];

      const commentsRef = ref(database, "comments");
      const newReplyRef = push(commentsRef);

      const replyData: any = {
        articleSlug: PLAYGROUND_ARTICLE_SLUG,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email || "Anonymous",
        content: replyText,
        createdAt: Date.now(),
        likes: 0,
        likedBy: {},
        parentCommentId: commentId,
      };

      // Fetch user's custom photoURL from Firebase database
      try {
        const { ref: dbRef, get } = await import("firebase/database");
        const { database: db } = await import("@/lib/firebase");
        if (db) {
          const userRef = dbRef(db, `users/${currentUser.uid}`);
          const userSnapshot = await get(userRef);
          if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            if (userData.photoURL && userData.photoURL.trim()) {
              replyData.authorPhotoURL = userData.photoURL;
            }
          }
        }
      } catch (error) {
        console.log("Could not fetch user photo, using default");
      }

      // Fallback to currentUser.photoURL if no custom photo
      if (!replyData.authorPhotoURL && currentUser.photoURL && currentUser.photoURL.trim()) {
        replyData.authorPhotoURL = currentUser.photoURL;
      }

      // Only add optional fields if they have values
      if (replyImage) {
        replyData.imageUrl = replyImage;
        replyData.imageSize = replyImageSize;
      }
      if (links.length > 0) {
        replyData.links = links;
      }

      await set(newReplyRef, replyData);

      setReplyText("");
      setReplyingTo(null);
      setReplyImage(null);
      setReplyImageSize(0);
      await loadCommentsFromFirebase();
    } catch (error) {
      console.error("Error creating reply:", error);
      alert("Fout bij plaatsen reply");
    }
  }

  async function handleLikeComment(commentId: string) {
    if (!currentUser) {
      alert("Je moet ingelogd zijn om te liken");
      return;
    }

    try {
      const { ref, get, update } = await import("firebase/database");
      const { database } = await import("@/lib/firebase");

      if (!database) return;

      const commentRef = ref(database, `comments/${commentId}`);
      const snapshot = await get(commentRef);

      if (snapshot.exists()) {
        const comment = snapshot.val();
        const likedBy = comment.likedBy || {};
        const hasLiked = likedBy[currentUser.uid];

        if (hasLiked) {
          // Unlike
          delete likedBy[currentUser.uid];
          await update(commentRef, {
            likes: Math.max(0, (comment.likes || 0) - 1),
            likedBy,
          });
        } else {
          // Like
          likedBy[currentUser.uid] = true;
          await update(commentRef, {
            likes: (comment.likes || 0) + 1,
            likedBy,
          });
        }

        loadCommentsFromFirebase();
      }
    } catch (error) {
      console.error("Error liking comment:", error);
    }
  }

  // Handle image upload (max 300kb)
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>, isReply: boolean = false) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Check file type
    if (!file.type.startsWith('image/')) {
      alert('Alleen afbeeldingen zijn toegestaan');
      return;
    }

    // Check file size (300KB = 307200 bytes)
    if (file.size > 307200) {
      alert('Afbeelding is te groot! Maximum 300KB');
      return;
    }

    // Convert to base64
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64String = reader.result as string;
      if (isReply) {
        setReplyImage(base64String);
        setReplyImageSize(file.size);
      } else {
        setSelectedImage(base64String);
        setImageSize(file.size);
      }
    };
    reader.readAsDataURL(file);
  };

  // Format text with clickable links
  const formatTextWithLinks = (text: string) => {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const parts = text.split(urlRegex);

    return parts.map((part, index) => {
      if (part.match(urlRegex)) {
        return (
          <a
            key={index}
            href={part}
            target="_blank"
            rel="noopener noreferrer"
            className="text-primary-600 dark:text-primary-400 hover:underline font-medium"
          >
            {part}
          </a>
        );
      }
      return <span key={index}>{part}</span>;
    });
  };

  // Render a single comment and its nested replies
  const renderComment = (comment: Comment, depth: number = 0) => {
    const isNested = depth > 0;
    const avatarSize = isNested ? "h-8 w-8" : "h-10 w-10";
    const textSize = isNested ? "text-sm" : "text-base";
    const isLiked = comment.likedBy?.[currentUser?.uid || ""];

    return (
      <div key={comment.id} className="space-y-3">
        {/* Comment Card */}
        <div
          className={`bg-slate-50 dark:bg-slate-900 rounded-lg p-4 border border-slate-200 dark:border-slate-700 ${
            isNested ? "text-sm" : ""
          }`}
        >
          <div className="flex items-start gap-3">
            {/* Avatar */}
            <div className="flex-shrink-0">
              {comment.authorPhotoURL && comment.authorPhotoURL.trim() && (comment.authorPhotoURL.startsWith('http') || comment.authorPhotoURL.startsWith('data:image')) ? (
                <>
                  <img
                    alt={comment.authorName}
                    className={`${avatarSize} rounded-full object-cover bg-slate-200 dark:bg-slate-700`}
                    src={comment.authorPhotoURL}
                    referrerPolicy="no-referrer"
                    crossOrigin="anonymous"
                    onError={(e) => {
                      console.log('Image failed to load:', comment.authorPhotoURL);
                      const target = e.target as HTMLImageElement;
                      target.style.display = 'none';
                      const fallback = target.nextElementSibling as HTMLElement;
                      if (fallback) fallback.style.display = 'flex';
                    }}
                    onLoad={() => console.log('Image loaded successfully:', comment.authorPhotoURL)}
                  />
                  <div
                    className={`${avatarSize} rounded-full bg-primary-600 text-white items-center justify-center font-bold`}
                    style={{ fontSize: isNested ? '0.75rem' : '1rem', display: 'none' }}
                  >
                    {comment.authorName?.charAt(0)?.toUpperCase() || '?'}
                  </div>
                </>
              ) : (
                <div
                  className={`${avatarSize} rounded-full bg-primary-600 text-white flex items-center justify-center font-bold`}
                  style={{ fontSize: isNested ? '0.75rem' : '1rem' }}
                  title={`No photo URL: ${comment.authorPhotoURL || 'undefined'}`}
                >
                  {comment.authorName?.charAt(0)?.toUpperCase() || '?'}
                </div>
              )}
            </div>

            <div className="flex-1 min-w-0">
              {/* Header */}
              <div className="flex items-center flex-wrap gap-2 mb-1">
                <span
                  className={`font-semibold text-slate-900 dark:text-white ${
                    isNested ? "text-sm" : ""
                  }`}
                >
                  {comment.authorName}
                </span>
                {comment.authorId === currentUser?.uid && (
                  <span
                    className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-medium bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-200 ${
                      isNested ? "text-[10px]" : "text-xs"
                    }`}
                    title="Jij"
                  >
                    <span>üë§</span>
                    <span>Jij</span>
                  </span>
                )}
                {/* User badges */}
                {(() => {
                  const userStat = userStats.find(s => s.userId === comment.authorId);
                  if (!userStat) return null;

                  const levelName = getLevelName(userStat.level);
                  const levelColor = userStat.level >= 5 ? 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300' :
                                    userStat.level >= 3 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' :
                                    'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';

                  return (
                    <>
                      <span
                        className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-medium ${levelColor} ${
                          isNested ? "text-[10px]" : "text-xs"
                        }`}
                        title={`Level ${userStat.level} - ${userStat.score} punten`}
                      >
                        {userStat.level >= 5 ? 'üëë' : userStat.level >= 3 ? '‚≠ê' : 'üî∞'} {levelName}
                      </span>
                      {userStat.badges.length > 0 && (
                        <span
                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300 ${
                            isNested ? "text-[10px]" : "text-xs"
                          }`}
                          title={`${userStat.badges.length} badges: ${userStat.badges.map(b => BADGES.find(badge => badge.id === b)?.name).join(', ')}`}
                        >
                          üèÜ {userStat.badges.length}
                        </span>
                      )}
                    </>
                  );
                })()}
                {comment.isPinned && (
                  <span
                    className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-medium bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 ${
                      isNested ? "text-[10px]" : "text-xs"
                    }`}
                    title="Vastgepind door moderator"
                  >
                    <Pin className="h-3 w-3" /> Pinned
                  </span>
                )}
                {comment.isBestAnswer && (
                  <span
                    className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300 ${
                      isNested ? "text-[10px]" : "text-xs"
                    }`}
                    title="Beste antwoord"
                  >
                    <CheckCircle className="h-3 w-3" /> Best Answer
                  </span>
                )}
                <span
                  className={`text-slate-500 dark:text-slate-400 ${
                    isNested ? "text-xs" : "text-sm"
                  }`}
                >
                  {formatDistanceToNow(comment.createdAt, {
                    addSuffix: true,
                    locale: nl,
                  })}
                  {comment.editedAt && (
                    <span className="ml-1 text-xs" title={`Bewerkt op ${new Date(comment.editedAt).toLocaleString('nl-NL')}`}>
                      (bewerkt)
                    </span>
                  )}
                </span>
              </div>

              {/* Content */}
              <div className={`text-slate-700 dark:text-slate-300 whitespace-pre-wrap break-words mb-3 ${textSize}`}>
                {formatTextWithLinks(comment.content)}
              </div>

              {/* Image attachment */}
              {comment.imageUrl && (
                <div className="mb-3">
                  <img
                    src={comment.imageUrl}
                    alt="Uploaded attachment"
                    className="max-w-full rounded-lg border-2 border-slate-200 dark:border-slate-700 max-h-96 object-contain"
                  />
                  {comment.imageSize && (
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      {(comment.imageSize / 1024).toFixed(1)} KB
                    </p>
                  )}
                </div>
              )}

              {/* Actions */}
              <div className="flex items-center gap-4">
                <button
                  onClick={() => handleLikeComment(comment.id)}
                  disabled={!currentUser}
                  className={`inline-flex items-center gap-1.5 font-medium transition-colors ${
                    isNested ? "text-xs" : "text-sm"
                  } ${
                    isLiked
                      ? "text-accent-600 dark:text-accent-400"
                      : "text-slate-500 hover:text-accent-600 dark:text-slate-400 dark:hover:text-accent-400"
                  } disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  <ThumbsUp
                    className={isNested ? "h-3.5 w-3.5" : "h-4 w-4"}
                    fill={isLiked ? "currentColor" : "none"}
                  />
                  {comment.likes || 0}
                </button>
                <button
                  onClick={() =>
                    setReplyingTo(
                      replyingTo === comment.id ? null : comment.id
                    )
                  }
                  disabled={!currentUser}
                  className={`inline-flex items-center gap-1.5 text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 font-medium transition-colors ${
                    isNested ? "text-xs" : "text-sm"
                  } disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  <MessageSquare className={isNested ? "h-3.5 w-3.5" : "h-4 w-4"} />
                  Reageren
                </button>
              </div>

              {/* Reply Form */}
              {replyingTo === comment.id && currentUser && (
                <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                  <textarea
                    value={replyText}
                    onChange={(e) => setReplyText(e.target.value)}
                    rows={3}
                    placeholder={`Reageer op ${comment.authorName}... (URLs worden automatisch klikbaar)`}
                    className="w-full px-3 py-2 rounded-lg border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:border-primary-500 dark:focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 transition-colors resize-none text-sm"
                  />

                  {/* Reply image preview */}
                  {replyImage && (
                    <div className="mt-3 relative inline-block">
                      <img
                        src={replyImage}
                        alt="Preview"
                        className="max-w-xs rounded-lg border-2 border-slate-300 dark:border-slate-600"
                      />
                      <button
                        type="button"
                        onClick={() => {
                          setReplyImage(null);
                          setReplyImageSize(0);
                        }}
                        className="absolute top-2 right-2 p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors"
                      >
                        <X className="h-3.5 w-3.5" />
                      </button>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                        {(replyImageSize / 1024).toFixed(1)} KB / 300 KB
                      </p>
                    </div>
                  )}

                  <div className="flex gap-2 mt-2">
                    <button
                      onClick={() => handleSubmitReply(comment.id)}
                      disabled={!replyText.trim()}
                      className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-semibold text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Plaats reply
                    </button>

                    {/* Image upload for reply */}
                    <label className="inline-flex items-center gap-1.5 px-3 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold cursor-pointer transition-colors text-sm">
                      <ImageIcon className="h-4 w-4" />
                      <span className="hidden sm:inline">Foto</span>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => handleImageUpload(e, true)}
                        className="hidden"
                      />
                    </label>

                    <button
                      onClick={() => {
                        setReplyingTo(null);
                        setReplyText("");
                        setReplyImage(null);
                        setReplyImageSize(0);
                      }}
                      className="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-900 dark:text-white rounded-lg font-semibold text-sm transition-colors"
                    >
                      Annuleren
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Nested Replies */}
        {comment.replies && comment.replies.length > 0 && (
          <div className="ml-12 space-y-3 border-l-2 border-primary-200 dark:border-primary-800 pl-4">
            {comment.replies.map((reply) => renderComment(reply, depth + 1))}
          </div>
        )}
      </div>
    );
  };

  const exportHTML = () => {
    const html = document.querySelector(".comments-container")?.outerHTML || "";
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "threaded-comments.html";
    a.click();
    URL.revokeObjectURL(url);
  };

  const copyHTML = () => {
    const html = document.querySelector(".comments-container")?.outerHTML || "";
    navigator.clipboard.writeText(html);
    alert("HTML copied to clipboard!");
  };

  return (
    <>
      <Header onOpenAuthModal={() => setAuthModalOpen(true)} />

      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
        <div className="max-w-4xl mx-auto px-4 py-8">
          <div className="mb-8">
        <Link href="/playground" className="inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 font-semibold mb-4">
          <ArrowLeft className="h-4 w-4" />
          Terug naar Playground
        </Link>

        <h1 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">
          üßµ Threaded Replies Demo
        </h1>
        <p className="text-slate-600 dark:text-slate-400">
          Test onbeperkt geneste comments met visuele hi√´rarchie
        </p>
      </div>

      <div className="bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 p-4 mb-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <Code className="h-5 w-5 text-primary-600 dark:text-primary-400" />
            <span className="font-semibold text-slate-900 dark:text-white">Controls & Export</span>
          </div>
          <div className="flex gap-2">
            <button onClick={copyHTML} className="inline-flex items-center gap-2 px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-900 dark:text-white rounded-lg font-semibold text-sm transition-colors">
              <Copy className="h-4 w-4" />
              Copy HTML
            </button>
            <button onClick={exportHTML} className="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-semibold text-sm transition-colors">
              <Download className="h-4 w-4" />
              Download HTML
            </button>
          </div>
        </div>

        <div className="flex items-center gap-4 pt-4 border-t border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-2">
            <Database className="h-4 w-4 text-slate-500 dark:text-slate-400" />
            <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Data Source:</span>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setUseLiveData(true)}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${useLiveData ? "bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300" : "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"}`}
            >
              üî¥ Live Firebase
            </button>
            <button
              onClick={() => setUseLiveData(false)}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${!useLiveData ? "bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300" : "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"}`}
            >
              üìã Sample Data
            </button>
          </div>
          <button
            onClick={() => useLiveData ? loadCommentsFromFirebase() : loadSampleData()}
            className="ml-auto inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium transition-colors"
          >
            <RefreshCw className="h-4 w-4" />
            Refresh
          </button>
          <button
            onClick={() => setShowLeaderboard(!showLeaderboard)}
            className="inline-flex items-center gap-2 px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-semibold transition-colors"
          >
            <Trophy className="h-4 w-4" />
            Top {userStats.length}
          </button>
          <button
            onClick={() => setShowBadges(!showBadges)}
            className="inline-flex items-center gap-2 px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-semibold transition-colors"
          >
            <Award className="h-4 w-4" />
            Badges
          </button>
        </div>
      </div>

      {/* Leaderboard Modal */}
      {showLeaderboard && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Trophy className="h-8 w-8 text-yellow-500" />
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Leaderboard</h2>
              </div>
              <button
                onClick={() => setShowLeaderboard(false)}
                className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                <X className="h-5 w-5 text-slate-500 dark:text-slate-400" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-6">
              {userStats.length === 0 ? (
                <div className="text-center py-12 text-slate-500 dark:text-slate-400">
                  Nog geen gebruikers met statistieken
                </div>
              ) : (
                <div className="space-y-3">
                  {userStats.map((stat, index) => {
                    const isCurrentUser = currentUser?.uid === stat.userId;
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : null;
                    const levelName = getLevelName(stat.level);

                    return (
                      <div
                        key={stat.userId}
                        className={`flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${
                          isCurrentUser
                            ? 'bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700'
                            : 'bg-slate-50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600'
                        }`}
                      >
                        <div className="flex items-center justify-center w-12 h-12 rounded-full bg-slate-200 dark:bg-slate-600 font-bold text-lg">
                          {medal || `#${rank}`}
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-bold text-slate-900 dark:text-white">
                              {stat.displayName}
                            </span>
                            {isCurrentUser && (
                              <span className="px-2 py-0.5 bg-primary-600 text-white text-xs rounded-full font-semibold">
                                Jij
                              </span>
                            )}
                            <span className={`px-2 py-0.5 text-xs rounded-full font-semibold ${
                              stat.level >= 5 ? 'bg-purple-500 text-white' :
                              stat.level >= 3 ? 'bg-blue-500 text-white' :
                              'bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-slate-300'
                            }`}>
                              {levelName}
                            </span>
                          </div>
                          <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
                            <span className="flex items-center gap-1">
                              <MessageSquare className="h-3.5 w-3.5" />
                              {stat.commentsCount}
                            </span>
                            <span className="flex items-center gap-1">
                              <ThumbsUp className="h-3.5 w-3.5" />
                              {stat.likesReceived}
                            </span>
                            <span className="flex items-center gap-1">
                              <CheckCircle className="h-3.5 w-3.5" />
                              {stat.bestAnswers}
                            </span>
                            {stat.badges.length > 0 && (
                              <span className="flex items-center gap-1">
                                <Award className="h-3.5 w-3.5" />
                                {stat.badges.length}
                              </span>
                            )}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-primary-600 dark:text-primary-400">
                            {stat.score}
                          </div>
                          <div className="text-xs text-slate-500 dark:text-slate-400">punten</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Badges Info Modal */}
      {showBadges && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Award className="h-8 w-8 text-purple-500" />
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Badges & Prestaties</h2>
              </div>
              <button
                onClick={() => setShowBadges(false)}
                className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                <X className="h-5 w-5 text-slate-500 dark:text-slate-400" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {BADGES.map((badge) => {
                  const Icon = {
                    'first-post': MessageSquare,
                    'conversationalist': Star,
                    'popular': ThumbsUp,
                    'expert': Award,
                    'veteran': Crown,
                    'legend': Trophy,
                    'helper': CheckCircle,
                    'on-fire': Flame
                  }[badge.id] || Award;

                  return (
                    <div
                      key={badge.id}
                      className="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50"
                    >
                      <div className="flex items-start gap-3 mb-2">
                        <div className="p-2 bg-white dark:bg-slate-600 rounded-lg">
                          <Icon className={`h-6 w-6 ${badge.color}`} />
                        </div>
                        <div className="flex-1">
                          <h3 className="font-bold text-slate-900 dark:text-white mb-1">
                            {badge.name}
                          </h3>
                          <p className="text-sm text-slate-600 dark:text-slate-400">
                            {badge.description}
                          </p>
                        </div>
                      </div>
                      <div className="text-xs text-slate-500 dark:text-slate-500 bg-white dark:bg-slate-800 rounded-lg px-3 py-2">
                        <strong>Vereiste:</strong> {badge.requirement}
                      </div>
                    </div>
                  );
                })}
              </div>

              <div className="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-800">
                <h3 className="font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                  <Target className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                  Level Systeem
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-slate-700 dark:text-slate-300">Lvl 1 - Rookie</div>
                    <div className="text-xs text-slate-500">0-99 punten</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-slate-700 dark:text-slate-300">Lvl 2 - Member</div>
                    <div className="text-xs text-slate-500">100-249 punten</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-slate-700 dark:text-slate-300">Lvl 3 - Regular</div>
                    <div className="text-xs text-slate-500">250-499 punten</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-blue-600 dark:text-blue-400">Lvl 4 - Veteran</div>
                    <div className="text-xs text-slate-500">500-999 punten</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-purple-600 dark:text-purple-400">Lvl 5 - Expert</div>
                    <div className="text-xs text-slate-500">1000-1999 punten</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 rounded-lg p-3">
                    <div className="font-semibold text-yellow-600 dark:text-yellow-400">Lvl 6 - Legend</div>
                    <div className="text-xs text-slate-500">2000+ punten</div>
                  </div>
                </div>
                <div className="mt-3 text-xs text-slate-600 dark:text-slate-400">
                  <strong>Puntensysteem:</strong> Reactie = 10 punten ‚Ä¢ Like ontvangen = 5 punten ‚Ä¢ Best Answer = 50 punten
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="comments-container bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 p-6 shadow-lg">
        <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-3">
          <MessageSquare className="h-6 w-6 text-primary-600 dark:text-primary-400" />
          Reacties
          <span className="text-base font-normal text-slate-500 dark:text-slate-400">({comments.length})</span>
        </h3>

        {currentUser ? (
          <form onSubmit={handleSubmitComment} className="mb-8">
            <div className="mb-4">
              <label htmlFor="commentText" className="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                Plaats een reactie
              </label>
              <textarea
                id="commentText"
                value={newComment}
                onChange={(e) => setNewComment(e.target.value)}
                rows={4}
                required
                placeholder="Deel je mening... (URLs worden automatisch klikbaar)"
                className="w-full px-4 py-3 rounded-lg border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:border-primary-500 dark:focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 transition-colors resize-none"
              />
            </div>

            {/* Image preview */}
            {selectedImage && (
              <div className="mb-4 relative inline-block">
                <img
                  src={selectedImage}
                  alt="Preview"
                  className="max-w-xs rounded-lg border-2 border-slate-300 dark:border-slate-600"
                />
                <button
                  type="button"
                  onClick={() => {
                    setSelectedImage(null);
                    setImageSize(0);
                  }}
                  className="absolute top-2 right-2 p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors"
                >
                  <X className="h-4 w-4" />
                </button>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  {(imageSize / 1024).toFixed(1)} KB / 300 KB
                </p>
              </div>
            )}

            <div className="flex items-center gap-3">
              <button
                type="submit"
                disabled={!newComment.trim()}
                className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <MessageSquare className="h-5 w-5" />
                Plaats reactie
              </button>

              {/* Image upload button */}
              <label className="inline-flex items-center gap-2 px-4 py-3 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold cursor-pointer transition-colors">
                <ImageIcon className="h-5 w-5" />
                <span className="hidden sm:inline">Afbeelding</span>
                <span className="text-xs">(max 300KB)</span>
                <input
                  type="file"
                  accept="image/*"
                  onChange={(e) => handleImageUpload(e, false)}
                  className="hidden"
                />
              </label>

              {selectedImage && (
                <button
                  type="button"
                  onClick={() => {
                    setSelectedImage(null);
                    setImageSize(0);
                  }}
                  className="inline-flex items-center gap-2 px-4 py-3 bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg font-semibold transition-colors"
                >
                  <Trash2 className="h-5 w-5" />
                  Verwijder
                </button>
              )}
            </div>
          </form>
        ) : (
          <div className="mb-8 p-4 bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 rounded-lg">
            <p className="text-sm text-yellow-800 dark:text-yellow-200">
              ‚ö†Ô∏è Je moet ingelogd zijn om reacties te plaatsen. Klik op "Inloggen" in de header.
            </p>
          </div>
        )}

        {loading ? (
          <div className="text-center py-12">
            <RefreshCw className="h-8 w-8 animate-spin text-primary-600 dark:text-primary-400 mx-auto mb-3" />
            <p className="text-slate-600 dark:text-slate-400">Laden...</p>
          </div>
        ) : comments.length === 0 ? (
          <div className="text-center py-12">
            <MessageSquare className="h-12 w-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
            <p className="text-slate-600 dark:text-slate-400 mb-2">Nog geen reacties</p>
            <p className="text-sm text-slate-500 dark:text-slate-500">
              {useLiveData ? "Plaats de eerste reactie!" : "Schakel naar Live Firebase om reacties te plaatsen"}
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            {comments.map((comment) => renderComment(comment))}
          </div>
        )}
      </div>

      <div className="mt-6 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-xl p-6">
        <h3 className="text-lg font-bold text-blue-900 dark:text-blue-100 mb-3">üí° Implementation Notes</h3>
        <ul className="space-y-2 text-sm text-blue-800 dark:text-blue-200">
          <li>‚Ä¢ <strong>Onbeperkte diepte</strong>: Recursieve rendering van nested replies</li>
          <li>‚Ä¢ <strong>Visuele hi√´rarchie</strong>: Kleinere avatars/text bij diepere nesting</li>
          <li>‚Ä¢ <strong>Firebase structuur</strong>: Gebruik <code>parentCommentId</code> field</li>
          <li>‚Ä¢ <strong>Performance</strong>: Overweeg virtualisatie bij &gt;100 comments</li>
        </ul>
      </div>
        </div>
      </div>

      <AuthModal
        isOpen={authModalOpen}
        onClose={() => setAuthModalOpen(false)}
      />
    </>
  );
}
